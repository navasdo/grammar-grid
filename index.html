<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Grid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
        }
        .word-box {
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s, background-color 0.2s;
        }
        @keyframes glowing-border {
            0% { box-shadow: 0 0 10px #DA70D6, 0 0 20px #DA70D6; }
            50% { box-shadow: 0 0 20px #C3B1E1, 0 0 40px #C3B1E1; }
            100% { box-shadow: 0 0 10px #DA70D6, 0 0 20px #DA70D6; }
        }
        .glow {
            animation: glowing-border 1.5s ease-in-out forwards;
        }
        @keyframes word-pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: none;
            }
            50% { 
                transform: scale(1.1);
                box-shadow: 0 0 15px rgba(218, 112, 214, 0.8), 0 0 30px rgba(195, 177, 225, 0.5);
            }
        }
        .word-box.animate {
            animation: word-pulse 2s ease-in-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icon Components ---
        const IconSpinner = ({ className }) => (
          <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        );
        
        const IconFullscreenEnter = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
        );

        const IconFullscreenExit = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>
        );
        
        const IconCheck = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
        );
        
        const IconReset = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M22 11.5A10 10 0 0 0 12.5 3a9.99 9.99 0 0 0-6.2 2.3L2.5 9"/><path d="M2 12.5A10 10 0 0 0 11.5 21a9.99 9.99 0 0 0 6.2-2.3L21.5 15"/></svg>
        );

        // --- Main App Component ---
        function App() {
          const [screen, setScreen] = useState('setup'); // 'setup', 'app', 'results'
          const [isLoading, setIsLoading] = useState(false);
          const [error, setError] = useState(null);
          const [isFullscreen, setIsFullscreen] = useState(false);
          
          const toggleFullscreen = () => {
            if (!document.fullscreenElement) {
              document.documentElement.requestFullscreen().catch(err => {
                setError("Fullscreen mode is not permitted in this view.");
              });
            } else {
              if (document.exitFullscreen) {
                document.exitFullscreen();
              }
            }
          };

          useEffect(() => {
            const handleFullscreenChange = () => {
              setIsFullscreen(!!document.fullscreenElement);
            };
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            return () => document.removeEventListener('fullscreenchange', handleFullscreenChange);
          }, []);
          
          useEffect(() => {
            if (error) {
                const timeoutId = setTimeout(() => setError(null), 5000);
                return () => clearTimeout(timeoutId);
            }
          }, [error]);
          
          // Placeholder functions
          const handleStart = () => setScreen('app');
          const handleSubmit = () => setScreen('results');
          const handleRestart = () => setScreen('setup');

          const renderScreen = () => {
            switch (screen) {
              case 'app':
                return <MainAppScreen onSubmit={handleSubmit} />;
              case 'results':
                return <ResultsScreen onRestart={handleRestart} />;
              case 'assessmentSetup':
                return <AssessmentSetupScreen onStartAssessment={handleStart} />;
              case 'setup':
              default:
                return <TutorialScreen onStartAssessment={() => setScreen('assessmentSetup')} isLoading={isLoading} />;
            }
          };

          return (
            <div className="bg-[#5B4B62] min-h-screen font-sans text-[#dee2e6] relative">
              <button 
                onClick={toggleFullscreen}
                className="absolute top-4 left-4 z-10 p-2 rounded-full bg-[#8B87A1]/50 hover:bg-[#C3B1E1] transition text-[#dee2e6]"
                title={isFullscreen ? "Exit Fullscreen" : "Enter Fullscreen"}
              >
                {isFullscreen ? <IconFullscreenExit /> : <IconFullscreenEnter />}
              </button>
               <a href="/" className="absolute top-4 right-4 z-10 p-1 rounded-full bg-[#8B87A1]/50 hover:bg-[#C3B1E1] transition" title="Back to Homepage">
                    <img src="https://raw.githubusercontent.com/navasdo/oliver/main/navacite/gems/Navacite-Main.png" alt="Navacite Homepage" className="w-10 h-10 rounded-full"/>
                </a>
              <div className="container mx-auto p-4 sm:p-6 lg:p-8">
                <header className="text-center mb-8">
                  <img 
                    src="https://raw.githubusercontent.com/navasdo/grammar-grid/refs/heads/main/navacite-gg.png" 
                    alt="App Gem" 
                    className="w-48 mx-auto mb-4 drop-shadow-[0_0_15px_rgba(255,255,255,0.7)]"
                  />
                  <h1 className="text-4xl font-bold text-[7F00FF]">Grammar Grid</h1>
                  <p className="text-sm text-[#aea2a6] italic mt-2">Concept by Daniel Navas, M.A., CCC-SLP & Coded in Tandem with Google Gemini</p>
                </header>
                {error && <div className="text-red-400 bg-red-900/50 p-3 rounded-lg text-center my-4 max-w-4xl mx-auto">{error}</div>}
                <main className="bg-[#8B87A1]/50 p-6 sm:p-8 rounded-2xl shadow-lg max-w-4xl mx-auto border border-[#AEA2A6]">
                  {renderScreen()}
                </main>
              </div>
            </div>
          );
        }

        // --- Tutorial Screen ---
        const TutorialScreen = ({ onStartAssessment, isLoading }) => {
          const [words, setWords] = useState([
            { id: 1, text: "tasty", inSentence: false },
            { id: 2, text: "the ice cream", inSentence: false },
            { id: 3, text: "is", inSentence: false }
          ]);
          const [sentence, setSentence] = useState([]);
          const [sentencesCompleted, setSentencesCompleted] = useState(0);
          const [shake, setShake] = useState(false);
          const [showPopup, setShowPopup] = useState(true);
          const [isGlowing, setIsGlowing] = useState(false);
          const [isWordBoxAnimated, setIsWordBoxAnimated] = useState(false);

          const audioRef = useRef({});

          const correctSentences = [
            ["the ice cream", "is", "tasty"],
            ["is", "the ice cream", "tasty"]
          ];
          
          const formattedSentences = sentence.map((word, index) => (
            <span 
              key={index} 
              className="px-3 py-2 bg-[#AEA2A6]/50 text-[#5B4B62] rounded-lg cursor-default shadow-sm font-semibold"
            >
              {word.text}
            </span>
          ));

          const getScoreColor = () => {
            if (sentencesCompleted === 2) return 'text-green-500';
            if (sentencesCompleted === 1) return 'text-orange-400';
            return 'text-gray-400';
          };
          
          const getRemainingWords = () => words.filter(w => !w.inSentence);

          const handleWordClick = (wordId) => {
            const word = words.find(w => w.id === wordId);
            if (word && !word.inSentence) {
                setSentence(prev => [...prev, word]);
                setWords(prev => prev.map(w => w.id === wordId ? { ...w, inSentence: true } : w));
            }
          };

          const handleCheck = () => {
            if (sentence.length === 0) return;
            const currentSentence = sentence.map(w => w.text).join(' ');
            
            const isCorrect = correctSentences.some(correct => correct.join(' ') === currentSentence);

            if (isCorrect) {
              const newSentencesCompleted = sentencesCompleted + 1;
              setSentencesCompleted(newSentencesCompleted);

              if (newSentencesCompleted === 1) {
                const audioToPlay = currentSentence === "the ice cream is tasty" ? audioRef.current.statement : audioRef.current.question;
                playAudio(audioToPlay, () => {
                    handleReset();
                });
              } else {
                setIsGlowing(true);
                playAudio(audioRef.current.twoOutOfTwo, () => {
                  setTimeout(() => {
                    setIsGlowing(false);
                    playAudio(audioRef.current.finished, () => {
                      onStartAssessment();
                    });
                  }, 1500);
                });
              }
            } else {
              setShake(true);
              setTimeout(() => {
                setShake(false);
                handleReset();
              }, 1000);
            }
          };

          const playAudio = (audioElement, onEnded) => {
            if (audioElement) {
                audioElement.onended = onEnded;
                audioElement.play().catch(e => console.error("Audio playback failed:", e));
            }
          };

          const handleReset = () => {
            setSentence([]);
            setWords(words.map(w => ({ ...w, inSentence: false })));
          };

          const handlePass = () => {
              setSentencesCompleted(0);
              handleReset();
          };

          useEffect(() => {
            // These are the links where you should place your .wav files.
            audioRef.current.tutorial = new Audio("audio/tutorial.wav");
            audioRef.current.statement = new Audio("audio/statement.wav");
            audioRef.current.question = new Audio("audio/question.wav");
            audioRef.current.finished = new Audio("audio/finished.wav");
            audioRef.current.twoOutOfTwo = new Audio("audio/2_out_of_2.wav");
          }, []);

          // --- DATE LOGIC ---
          const currentDate = new Date().toLocaleDateString('en-US', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
          });

          return (
            <div className="space-y-8">
              {/* Popup Modal */}
              {showPopup && (
                <div className="absolute inset-0 bg-black/50 flex items-center justify-center z-40">
                  <div className="bg-[#5B4B62] p-8 rounded-2xl shadow-lg border border-[#AEA2A6] text-center max-w-sm">
                    <p className="font-bold text-lg mb-4">Begin with tutorial?</p>
                    <div className="flex justify-center space-x-4">
                      <button 
                        onClick={() => { 
                          setShowPopup(false);
                          playAudio(audioRef.current.tutorial, null);
                          setIsWordBoxAnimated(true);
                          setTimeout(() => setIsWordBoxAnimated(false), 2000);
                        }} 
                        className="px-6 py-2 bg-[#DA70D6] rounded-lg font-semibold hover:bg-[#C3B1E1] transition"
                      >
                        Yes
                      </button>
                      <button 
                        onClick={() => { setShowPopup(false); onStartAssessment(); }} 
                        className="px-6 py-2 bg-[#DA70D6] rounded-lg font-semibold hover:bg-[#C3B1E1] transition"
                      >
                        No
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Date Display */}
              <div className="text-center p-3 bg-[#8B87A1]/50 text-[#C3B1E1] rounded-lg">
                <p className="font-semibold">{currentDate}</p>
              </div>
              
              <div className="text-center">
                 <h2 className="text-2xl font-bold text-[#dee2e6]">Tutorial</h2>
              </div>

              {/* Sentence construction area */}
              <div className={`p-4 min-h-[6rem] border border-dashed border-[#AEA2A6] rounded-lg flex flex-wrap items-center justify-center gap-2 transition-all duration-300 ${shake ? 'shake' : ''} ${isGlowing ? 'glow' : ''}`}>
                {sentence.length > 0 ? formattedSentences : <span className="text-sm text-[#aea2a6] italic">Click words below to build your sentence...</span>}
              </div>

              {/* Word bank */}
              <div className="p-4 rounded-lg flex flex-wrap justify-center gap-2 bg-[#8B87A1]/50">
                {getRemainingWords().map(word => (
                  <button
                    key={word.id}
                    onClick={() => handleWordClick(word.id)}
                    className={`word-box px-4 py-2 bg-[#AEA2A6]/50 text-[#dee2e6] rounded-lg shadow-sm font-semibold ${isWordBoxAnimated ? 'animate' : ''}`}
                  >
                    {word.text}
                  </button>
                ))}
              </div>

              {/* Action buttons and score */}
              <div className="flex items-center justify-center space-x-4 mt-8">
                <button onClick={handleCheck} className="p-4 bg-[#DA70D6] rounded-full text-white hover:bg-[#C3B1E1] transition-transform transform hover:scale-105">
                  <IconCheck />
                </button>
                <div className="flex flex-col items-center">
                  <span className={`text-xl font-bold ${getScoreColor()}`}>
                    {sentencesCompleted}/2
                  </span>
                  <p className="text-sm text-[#aea2a6] italic">Score</p>
                </div>
                <button onClick={handleReset} className="p-4 bg-[#DA70D6] rounded-full text-white hover:bg-[#C3B1E1] transition-transform transform hover:scale-105">
                  <IconReset />
                </button>
                <button onClick={handlePass} className="px-6 py-4 bg-[#DA70D6] rounded-lg text-white font-bold hover:bg-[#C3B1E1] transition">
                  Pass
                </button>
              </div>

            </div>
          );
        };

        // --- Assessment Setup Screen ---
        const AssessmentSetupScreen = ({ onStartAssessment }) => {
          const [examinerName, setExaminerName] = useState('');
          const [gradeLevel, setGradeLevel] = useState('1');
          const [numQuestions, setNumQuestions] = useState(10);
          const [isMultiGrade, setIsMultiGrade] = useState(false);
          
          // New state for multiple grade selection
          const [multiGrades, setMultiGrades] = useState([
            { id: 1, grade: '1', questions: 0 },
            { id: 2, grade: '2', questions: 0 },
            { id: 3, grade: '3', questions: 0 }
          ]);
          
          const totalQuestions = multiGrades.reduce((sum, item) => sum + parseInt(item.questions), 0);
          const questionsLeft = 10 - totalQuestions;

          const handleMultiGradeChange = (id, field, value) => {
            setMultiGrades(prev => 
              prev.map(item => item.id === id ? { ...item, [field]: value } : item)
            );
          };

          return (
            <div className="space-y-8">
                <div className="text-center p-3 bg-[#8B87A1]/50 text-[#C3B1E1] rounded-lg">
                  <p className="font-semibold">{new Date().toLocaleDateString('en-US', {
                      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                    })}</p>
                </div>
                <h2 className="text-2xl font-bold text-center">Assessment Setup</h2>
                
                {/* Student Name Input (Disabled for FERPA) */}
                <div className="flex flex-col space-y-2">
                  <label htmlFor="student-name" className="text-lg font-semibold">Student Name</label>
                  <input
                    id="student-name"
                    type="text"
                    disabled
                    value="FERPA compliant: No student names entered. Please add manually to the exported PDF."
                    className="p-3 rounded-lg bg-[#AEA2A6]/30 text-[#6B7280] border border-[#AEA2A6] focus:outline-none focus:ring-2 focus:ring-[#C3B1E1]"
                  />
                </div>

                {/* Examiner Input */}
                <div className="flex flex-col space-y-2">
                  <label htmlFor="examiner" className="text-lg font-semibold">Examiner Name</label>
                  <input
                    id="examiner"
                    type="text"
                    value={examinerName}
                    onChange={(e) => setExaminerName(e.target.value)}
                    className="p-3 rounded-lg bg-[#AEA2A6]/30 text-[#dee2e6] border border-[#AEA2A6] focus:outline-none focus:ring-2 focus:ring-[#C3B1E1]"
                    placeholder="Enter examiner's name"
                  />
                </div>

                {/* Single Grade Level Setup */}
                <div className={`flex flex-col space-y-2 ${isMultiGrade ? 'hidden' : ''}`}>
                  <label htmlFor="grade-level" className="text-lg font-semibold">Grade Level</label>
                  <select
                    id="grade-level"
                    value={gradeLevel}
                    onChange={(e) => setGradeLevel(e.target.value)}
                    className="p-3 rounded-lg bg-[#AEA2A6]/30 text-[#dee2e6] border border-[#AEA2A6] focus:outline-none focus:ring-2 focus:ring-[#C3B1E1]"
                  >
                    {[...Array(12)].map((_, i) => (
                      <option key={i} value={i + 1}>Grade {i + 1}</option>
                    ))}
                  </select>
                </div>
                
                <div className="flex items-center space-x-2">
                  <input
                    id="multi-grade"
                    type="checkbox"
                    checked={isMultiGrade}
                    onChange={(e) => setIsMultiGrade(e.target.checked)}
                    className="w-5 h-5 accent-[#DA70D6] rounded"
                  />
                  <label htmlFor="multi-grade" className="text-lg font-semibold">Select multiple grade levels</label>
                </div>

                {/* Multiple Grade Level Setup */}
                {isMultiGrade ? (
                  <div className="bg-[#8B87A1]/40 p-6 rounded-lg space-y-4">
                    <h3 className="text-xl font-semibold text-[#dee2e6]">Questions by Grade Level (Questions Left: {questionsLeft})</h3>
                    <p className="text-sm italic text-[#AEA2A6]">Note: You do not need to use all 10 questions.</p>
                    {multiGrades.map(item => (
                      <div key={item.id} className="flex items-center space-x-4">
                        <label className="text-lg font-medium">Grade</label>
                        <select
                          value={item.grade}
                          onChange={(e) => handleMultiGradeChange(item.id, 'grade', e.target.value)}
                          className="p-2 rounded-lg bg-[#AEA2A6]/30 text-[#dee2e6] border border-[#AEA2A6] focus:outline-none focus:ring-2 focus:ring-[#C3B1E1]"
                        >
                          {[...Array(12)].map((_, i) => (
                            <option key={i} value={i + 1}>Grade {i + 1}</option>
                          ))}
                        </select>
                        <label className="text-lg font-medium">Questions</label>
                        <input
                          type="number"
                          value={item.questions}
                          onChange={(e) => {
                            const newValue = Math.min(parseInt(e.target.value) || 0, 10 - (totalQuestions - parseInt(item.questions)));
                            handleMultiGradeChange(item.id, 'questions', newValue);
                          }}
                          min="0"
                          max="10"
                          className="w-20 p-2 rounded-lg bg-[#AEA2A6]/30 text-[#dee2e6] border border-[#AEA2A6] focus:outline-none focus:ring-2 focus:ring-[#C3B1E1]"
                        />
                      </div>
                    ))}
                    <p className={`text-sm font-semibold ${questionsLeft < 0 ? 'text-red-400' : 'text-[#dee2e6]'}`}>Total Questions: {totalQuestions}/10</p>
                  </div>
                ) : (
                  <div className="flex flex-col space-y-2">
                    <label htmlFor="num-questions" className="text-lg font-semibold">Number of Questions (max 10)</label>
                    <input
                      id="num-questions"
                      type="number"
                      value={numQuestions}
                      onChange={(e) => setNumQuestions(Math.min(e.target.value, 10))}
                      min="1"
                      max="10"
                      className="p-3 rounded-lg bg-[#AEA2A6]/30 text-[#dee2e6] border border-[#AEA2A6] focus:outline-none focus:ring-2 focus:ring-[#C3B1E1]"
                    />
                  </div>
                )}
                
                <button
                  onClick={onStartAssessment}
                  disabled={totalQuestions > 10 || (isMultiGrade && totalQuestions === 0)}
                  className={`w-full py-4 bg-[#DA70D6] rounded-lg font-bold text-lg hover:bg-[#C3B1E1] transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed`}
                >
                  Start Assessment
                </button>
            </div>
          );
        };

        // --- Other Screen Components (placeholders) ---
        const MainAppScreen = ({ onSubmit }) => {
          return (
            <div className="space-y-8 text-center">
              <h2 className="text-2xl font-semibold text-[#dee2e6]">Main Application Screen</h2>
              <p className="text-[#AEA2A6]">This is where the main task of your app will happen. The app will proceed to this screen after the tutorial.</p>
              <button onClick={onSubmit} className="w-full md:w-auto px-12 py-4 bg-[#DA70D6] text-white font-bold text-lg rounded-lg shadow-md hover:bg-[#C3B1E1] focus:outline-none focus:ring-4 focus:ring-[#C3B1E1] transition-transform transform hover:scale-105">
                Submit
              </button>
            </div>
          );
        };
        
        const ResultsScreen = ({ onRestart }) => {
          return (
            <div className="space-y-8 text-center">
              <h2 className="text-2xl font-semibold text-[#dee2e6]">Results Screen</h2>
              <p className="text-[#AEA2A6]">This is where you'll display scores, reports, and provide options to export data or start over.</p>
               <button onClick={onRestart} className="w-full md:w-auto px-12 py-4 bg-[#DA70D6] text-white font-bold text-lg rounded-lg shadow-md hover:bg-[#C3B1E1] focus:outline-none focus:ring-4 focus:ring-[#C3B1E1] transition-transform transform hover:scale-105">
                 Start New
               </button>
            </div>
          );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
